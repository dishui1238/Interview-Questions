<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ‰‹å†™Promise</title>
</head>

<body>
  <script>
    const FULFILLED = "fulfilled";
    const PENDING = "pending";
    const REJECT = "reject";

    class MyPromise {
      constructor(executor) {
        // executor æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œç«‹å³æ‰§è¡Œ
        executor(this.resolve, this.reject);
      }

      status = PENDING;
      value = null;
      reason = null;
      // å­˜å‚¨æˆåŠŸå›žè°ƒå‡½æ•°
      onFulfilledCallback = [];
      // å­˜å‚¨å¤±è´¥å›žè°ƒå‡½æ•°
      onRejectedCallback = [];

      // æ›´æ”¹æˆåŠŸåŽçš„çŠ¶æ€
      resolve = (value) => {
        if (this.status === PENDING) {
          this.status = FULFILLED;
          this.value = value;

          // è°ƒç”¨æ‰€æœ‰æˆåŠŸçš„å›žè°ƒ
          while (this.onFulfilledCallback.length) {
            // Array.shift() å–å‡ºæ•°ç»„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œç„¶åŽï¼ˆï¼‰è°ƒç”¨ï¼Œ
            // shiftä¸æ˜¯çº¯å‡½æ•°ï¼Œå–å‡ºåŽï¼Œæ•°ç»„å°†å¤±åŽ»è¯¥å…ƒç´ ï¼Œç›´åˆ°æ•°ç»„ä¸ºç©º
            this.onFulfilledCallback.shift()(value);
          }
        }
      };

      // æ›´æ”¹å¤±è´¥åŽçš„çŠ¶æ€
      reject = (reason) => {
        if (this.status === PENDING) {
          this.status = REJECT;
          this.reason = reason;

          // è°ƒç”¨æ‰€æœ‰å¤±è´¥çš„å›žè°ƒ
          while (this.onRejectedCallback.length) {
            this.onRejectedCallback.shift()(value);
          }
        }
      };

      // TODO: then çš„é“¾å¼è°ƒç”¨
      then = (onFulfilled, onRejected) => {
        if (this.status === FULFILLED) {
          onFulfilled(this.value);
        } else if (this.status === REJECT) {
          onRejected(this.reson);
        } else if (this.status === PENDING) {
          // å› ä¸ºä¸çŸ¥é“åŽé¢çŠ¶æ€çš„å˜åŒ–æƒ…å†µï¼Œæ‰€ä»¥å°†æˆåŠŸå›žè°ƒå’Œå¤±è´¥å›žè°ƒå­˜å‚¨èµ·æ¥
          // ç­‰åˆ°æ‰§è¡ŒæˆåŠŸå¤±è´¥å‡½æ•°çš„æ—¶å€™å†ä¼ é€’
          this.onFulfilledCallback.push(onFulfilled);
          this.onRejectedCallback.push(onRejected);
        }
      };
    }

    // ================================ æµ‹è¯•ç”¨ä¾‹ ðŸŒ° ===============================================
    const promise = new MyPromise((resolve, reject) => {
      setTimeout(() => {
        resolve('success')
      }, 2000);
    })

    promise.then(value => {
      console.log(1)
      console.log('resolve', value)
    })

    promise.then(value => {
      console.log(2)
      console.log('resolve', value)
    })

    promise.then(value => {
      console.log(3)
      console.log('resolve', value)
    })
  </script>
  æ‰‹å†™Promise
</body>

</html>